name: Release

on:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "**"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to deploy (for feature previews)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  prepare-deploy:
    needs: ci
    runs-on: ubuntu-latest
    outputs:
      base_path: ${{ steps.vars.outputs.base_path }}
      target_dir: ${{ steps.vars.outputs.target_dir }}
    steps:
      - id: vars
        name: Resolve deploy target
        shell: bash
        run: |
          set -euo pipefail

          pr_number="${{ github.event.pull_request.number }}"
          manual_pr="${{ github.event.inputs.pr_number }}"

          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            base_path="/kami/"
            target_dir=""
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            if [[ -z "${pr_number}" ]]; then
              echo "PR number missing; cannot determine feature deploy target." >&2
              exit 1
            fi
            base_path="/kami/feat${pr_number}/"
            target_dir="feat${pr_number}"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && -n "${manual_pr}" ]]; then
            base_path="/kami/feat${manual_pr}/"
            target_dir="feat${manual_pr}"
          else
            branch="${GITHUB_REF#refs/heads/}"
            if [[ "${branch}" == "master" ]]; then
              base_path="/kami/master/"
              target_dir="master"
            else
              echo "Feature deployments use PR numbers; open a PR or pass pr_number on workflow_dispatch." >&2
              exit 1
            fi
          fi

          echo "base_path=${base_path}" >> "$GITHUB_OUTPUT"
          echo "target_dir=${target_dir}" >> "$GITHUB_OUTPUT"

  deploy:
    needs: [ci, prepare-deploy]
    uses: ./.github/workflows/cd.yml
    permissions:
      contents: read
      pages: write
      id-token: write
    secrets: inherit
    with:
      base_path: ${{ needs.prepare-deploy.outputs.base_path }}
      target_dir: ${{ needs.prepare-deploy.outputs.target_dir }}
